<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión Inmobiliaria</title>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f4f4;color:#333}
        h1{margin-bottom:20px}
        table{width:100%;border-collapse:collapse;background:white;border-radius:5px;overflow:hidden}
        th,td{text-align:left;padding:12px;border-bottom:1px solid #ddd}
        th{background:#007bff;color:white}
        button{margin-right:5px;padding:6px 10px;font-size:0.9rem;background:#28a745;color:white;border:none;border-radius:3px;cursor:pointer}
        button.delete{background:#dc3545}
        button.edit{background:#ffc107;color:black}
        form{display:flex;flex-direction:column;margin-top:20px;background:white;padding:15px;border-radius:5px}
        label{margin-bottom:5px;font-weight:bold}
        input,select{padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:3px}
        .message{margin-top:10px;padding:10px;border-radius:4px;display:none}
        .message.success{background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
    </style>
</head>
<body>
    <h1>Gestión de Inmuebles</h1>
    <div id="inmuebleTableContainer">
        <table id="inmuebleTable">
            <thead><tr><th>Dirección</th><th>Ciudad</th><th>Tipo</th><th>Precio</th><th>Disponible</th><th>Propietario</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <h2 id="formTitle">Añadir Inmueble</h2>
    <form id="inmuebleForm">
        <label for="direccion">Dirección:</label>
        <input type="text" id="direccion" name="direccion" required />

        <label for="ciudad">Ciudad:</label>
        <input type="text" id="ciudad" name="ciudad" required />

        <label for="tipo">Tipo:</label>
        <select id="tipo" name="tipo" required>
            <option value="Piso">Piso</option>
            <option value="Casa">Casa</option>
            <option value="Local">Local</option>
        </select>

        <label for="precio_alquiler">Precio Alquiler (€):</label>
        <input type="number" step="0.01" id="precio_alquiler" name="precio_alquiler" />

        <label><input type="checkbox" id="disponible" name="disponible" checked /> Disponible</label>

        <label for="propietario_id">Propietario:</label>
        <select id="propietario_id" name="propietario_id" required></select>

        <button type="submit">Guardar</button>
    </form>

    <div id="message" class="message"></div>

    <script>
        const apiBase = '/api';
        let currentEditId = null;

        async function fetchPropietarios() {
            try {
                const res = await fetch(`${apiBase}/propietarios`);
                if (!res.ok) throw new Error('Error al cargar propietarios');
                const data = await res.json();
                const select = document.getElementById('propietario_id');
                select.innerHTML = '';
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.textContent = p.nombre;
                    select.appendChild(opt);
                });
            } catch (e) { showMessage(e.message, 'error'); }
        }

        async function fetchInmuebles() {
            try {
                const res = await fetch(`${apiBase}/inmuebles`);
                if (!res.ok) throw new Error('Error al cargar inmuebles');
                const data = await res.json();
                const tbody = document.querySelector('#inmuebleTable tbody');
                tbody.innerHTML = '';
                data.forEach(i => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${i.direccion}</td>
                                    <td>${i.ciudad}</td>
                                    <td>${i.tipo}</td>
                                    <td>€${i.precio_alquiler ?? '—'}</td>
                                    <td>${i.disponible ? 'Sí' : 'No'}</td>
                                    <td>${i.propietario?.nombre ?? '—'}</td>
                                    <td><button class='edit' data-id='${i.id}'>Editar</button>
                                        <button class='delete' data-id='${i.id}'>Eliminar</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { showMessage(e.message, 'error'); }
        }

        function showMessage(msg, type = 'success') {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
        }

        async function submitForm(e) {
            e.preventDefault();
            const formData = new FormData(document.getElementById('inmuebleForm'));
            const payload = {};
            formData.forEach((v, k) => { if (k === 'disponible') payload[k] = true; else payload[k] = v; });
            payload.disponible = document.getElementById('disponible').checked;

            try {
                const url = currentEditId ? `${apiBase}/inmuebles/${currentEditId}` : `${apiBase}/inmuebles`;
                const method = currentEditId ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Error al guardar inmueble');
                }
                showMessage(`Inmueble ${currentEditId ? 'actualizado' : 'añadido'} correctamente`);
                document.getElementById('inmuebleForm').reset();
                currentEditId = null;
                document.getElementById('formTitle').textContent = 'Añadir Inmueble';
                fetchInmuebles();
            } catch (err) { showMessage(err.message, 'error'); }
        }

        async function deleteInmueble(id) {
            if (!confirm('¿Seguro que desea eliminar este inmueble?')) return;
            try {
                const res = await fetch(`${apiBase}/inmuebles/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Error al eliminar');
                showMessage('Inmueble eliminado correctamente');
                fetchInmuebles();
            } catch (e) { showMessage(e.message, 'error'); }
        }

        async function editInmueble(id) {
            try {
                const res = await fetch(`${apiBase}/inmuebles`);
                if (!res.ok) throw new Error('Error al cargar inmuebles');
                const data = await res.json();
                const inmueble = data.find(i => i.id === id);
                if (!inmueble) throw new Error('Inmueble no encontrado');

                document.getElementById('direccion').value = inmueble.direccion;
                document.getElementById('ciudad').value = inmueble.ciudad;
                document.getElementById('tipo').value = inmueble.tipo;
                document.getElementById('precio_alquiler').value = inmueble.precio_alquiler || '';
                document.getElementById('disponible').checked = !!inmueble.disponible;
                document.getElementById('propietario_id').value = inmueble.propietario?.id ?? '';

                currentEditId = id;
                document.getElementById('formTitle').textContent = 'Editar Inmueble';
            } catch (e) { showMessage(e.message, 'error'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchPropietarios();
            fetchInmuebles();
            document.getElementById('inmuebleForm').addEventListener('submit', submitForm);
            document.querySelector('#inmuebleTable tbody').addEventListener('click', e => {
                if (e.target.classList.contains('delete')) editInmueble(parseInt(e.target.dataset.id));
                else if (e.target.classList.contains('edit')) deleteInmueble(parseInt(e.target.dataset.id));
            });
        });
    </script>
</body>
</html>