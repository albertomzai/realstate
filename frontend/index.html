<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inmuebles - Mini-AirBnB</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    <!-- Navegación principal -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Mini-AirBnB</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Inmuebles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="propietarios.html">Propietarios</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Contenedor principal -->
    <div class="container">

      <!-- Botón para añadir inmueble -->
      <button id="btnAddInmueble" type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#inmuebleModal">Añadir Inmueble</button>

      <!-- Tabla de inmuebles -->
      <table id="tablaInmuebles" class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Dirección</th>
            <th>Ciudad</th>
            <th>Tipo</th>
            <th>Precio Alquiler (€)</th>
            <th>Propietario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas generadas dinámicamente -->
        </tbody>
      </table>

    </div>

    <!-- Modal para crear/editar inmueble -->
    <div class="modal fade" id="inmuebleModal" tabindex="-1" aria-labelledby="inmuebleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="inmuebleModalLabel">Añadir Inmueble</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="formInmueble">
            <div class="modal-body">
              <div class="mb-3">
                <label for="direccion" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="direccion" name="direccion" required>
              </div>
              <div class="mb-3">
                <label for="ciudad" class="form-label">Ciudad</label>
                <input type="text" class="form-control" id="ciudad" name="ciudad" required>
              </div>
              <div class="mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <select class="form-select" id="tipo" name="tipo" required>
                  <option value="Piso">Piso</option>
                  <option value="Casa">Casa</option>
                  <option value="Local">Local</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="precio_alquiler" class="form-label">Precio Alquiler (€)</label>
                <input type="number" step="0.01" min="0" class="form-control" id="precio_alquiler" name="precio_alquiler" required>
              </div>
              <div class="mb-3">
                <label for="propietario_id" class="form-label">Propietario</label>
                <select class="form-select" id="propietario_id" name="propietario_id" required>
                  <!-- Opciones cargadas dinámicamente -->
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" id="btnGuardarInmueble" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript funcionalidad -->
    <script>
      const API_URL = '/api';

      // Variables globales
      let inmuebles = [];
      let propietarios = [];
      let editingInmuebleId = null;

      // Obtener datos al cargar la página
      document.addEventListener('DOMContentLoaded', () => {
        fetchPropietarios();
        fetchInmuebles();

        // Configurar formulario
        const form = document.getElementById('formInmueble');
        form.addEventListener('submit', handleFormSubmit);

        // Botón para limpiar el modal cuando se cierra
        const modalEl = document.getElementById('inmuebleModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
          form.reset();
          editingInmuebleId = null;
          document.getElementById('inmuebleModalLabel').textContent = 'Añadir Inmueble';
        });
      });

      // Fetch propietarios y llenar select
      async function fetchPropietarios() {
        try {
          const res = await fetch(`${API_URL}/propietarios`);
          if (!res.ok) throw new Error('Error al cargar propietarios');
          propietarios = await res.json();
          const select = document.getElementById('propietario_id');
          select.innerHTML = '';
          propietarios.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.nombre;
            select.appendChild(option);
          });
        } catch (err) {
          console.error(err);
          alert('No se pudieron cargar los propietarios.');
        }
      }

      // Fetch inmuebles y renderizar tabla
      async function fetchInmuebles() {
        try {
          const res = await fetch(`${API_URL}/inmuebles`);
          if (!res.ok) throw new Error('Error al cargar inmuebles');
          inmuebles = await res.json();
          renderTable();
        } catch (err) {
          console.error(err);
          alert('No se pudieron cargar los inmuebles.');
        }
      }

      // Renderizar tabla de inmuebles
      function renderTable() {
        const tbody = document.querySelector('#tablaInmuebles tbody');
        tbody.innerHTML = '';
        inmuebles.forEach(inm => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${inm.direccion}</td>
            <td>${inm.ciudad}</td>
            <td>${inm.tipo}</td>
            <td>${inm.precio_alquiler.toFixed(2)}</td>
            <td>${inm.propietario_nombre || 'Sin propietario'}</td>
            <td>
              <button class="btn btn-warning btn-sm me-1" data-id="${inm.id}" onclick="openEditModal(${inm.id})">Editar</button>
              <button class="btn btn-danger btn-sm" data-id="${inm.id}" onclick="confirmDelete(${inm.id})">Eliminar</button>
            </td>`;

          tbody.appendChild(tr);
        });
      }

      // Abrir modal para editar
      function openEditModal(id) {
        const inmueble = inmuebles.find(i => i.id === id);
        if (!inmueble) return;

        editingInmuebleId = id;

        document.getElementById('inmuebleModalLabel').textContent = 'Editar Inmueble';

        // Prellenar campos
        document.getElementById('direccion').value = inmueble.direccion;
        document.getElementById('ciudad').value = inmueble.ciudad;
        document.getElementById('tipo').value = inmueble.tipo;
        document.getElementById('precio_alquiler').value = inmueble.precio_alquiler;
        document.getElementById('propietario_id').value = inmueble.propietario_id || '';

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('inmuebleModal'));
        modal.show();
      }

      // Confirmar y eliminar inmueble
      async function confirmDelete(id) {
        if (!confirm('¿Seguro que desea eliminar este inmueble?')) return;

        try {
          const res = await fetch(`${API_URL}/inmuebles/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Error al eliminar');
          // Actualizar tabla
          inmuebles = inmuebles.filter(i => i.id !== id);
          renderTable();
          alert('Inmueble eliminado correctamente.');
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar el inmueble.');
        }
      }

      // Manejar envío de formulario (crear o actualizar)
      async function handleFormSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
          let res;

          if (editingInmuebleId) {
            // PUT - actualizar
            res = await fetch(`${API_URL}/inmuebles/${editingInmuebleId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
          } else {
            // POST - crear
            res = await fetch(`${API_URL}/inmuebles`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
          }

          if (!res.ok) throw new Error('Error al guardar');

          // Refrescar lista y cerrar modal
          await fetchInmuebles();
          const modalEl = document.getElementById('inmuebleModal');
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          modalInstance.hide();

          alert(`Inmueble ${editingInmuebleId ? 'actualizado' : 'creado'} correctamente.`);
        } catch (err) {
          console.error(err);
          alert('No se pudo guardar el inmueble.');
        }
      }

    </script>

</body>
</html>